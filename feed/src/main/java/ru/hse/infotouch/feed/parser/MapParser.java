package ru.hse.infotouch.feed.parser;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;
import ru.hse.infotouch.domain.models.enums.MapElementType;
import ru.hse.infotouch.domain.models.map.SchemeElement;
import ru.hse.infotouch.domain.repo.SchemeElementRepository;

import java.util.List;
import java.util.stream.Collectors;

@Component
public class MapParser implements CommandLineRunner {

    private final SchemeElementRepository schemeElementRepository;

    public MapParser(SchemeElementRepository schemeElementRepository) {
        this.schemeElementRepository = schemeElementRepository;
    }

    @Override
    public void run(String... args) throws Exception {
        String elements = "<polygon id=\"333b\" points=\"175.892353 201.596696 206.472464 201.596696 206.472464 238.662118 175.892353 238.662118\"></polygon>\n" +
                "            <polygon id=\"333\" points=\"206.452108 201.702875 206.452108 238.622578 226.337213 238.622578 226.337213 201.702875\"></polygon>\n" +
                "            <polygon id=\"333a\" points=\"226.332728 238.664082 226.332728 201.924253 248.228284 201.924253 248.228284 238.664082\"></polygon>\n" +
                "            <polygon id=\"331a\" points=\"248.236297 238.559505 248.236297 201.913881 268.042996 201.913881 268.042996 238.559505\"></polygon>\n" +
                "            <polygon id=\"331\" points=\"267.989113 238.599193 267.989113 200.909689 288.465243 200.909689 288.465243 238.599193\"></polygon>\n" +
                "            <polygon id=\"329\" points=\"288.45786 200.827794 288.45786 240.756611 306.704117 240.756611 306.704117 200.827794\"></polygon>\n" +
                "            <polygon id=\"327\" points=\"306.821172 200.836188 306.821172 240.772944 325.133903 240.772944 325.133903 200.836188\"></polygon>\n" +
                "            <polygon id=\"325\" points=\"325.149395 200.857758 325.149395 243.079049 356.516717 243.079049 356.516717 221.968403 352.900301 221.968403 352.900301 200.857758\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"175.95588 238.680568 175.95588 257.146006 190.178656 257.146006 190.178656 253.650981 288.072271 252.125486 288.072271 255.212454 356.339741 255.212454 356.339741 243.036682 325.163322 243.036682 325.163322 240.797311 288.47069 240.797311 288.47069 238.680568\"></polygon>\n" +
                "            <polygon id=\"338\" points=\"176.007131 256.836291 176.007131 307.275718 209.532944 307.275718 209.532944 253.61734 190.524779 253.61734 190.524779 256.836291\"></polygon>\n" +
                "            <polygon id=\"336\" points=\"209.403437 253.231866 209.403437 307.211308 232.857904 307.211308 232.857904 252.694402\"></polygon>\n" +
                "            <polygon id=\"334b\" points=\"232.73452 253.322455 232.73452 307.234248 249.96981 307.234248 249.96981 252.717343\"></polygon>\n" +
                "            <polygon id=\"334\" points=\"250.018809 252.855478 250.018809 306.979006 265.711758 306.979006 266.597238 252.462101\"></polygon>\n" +
                "            <polygon id=\"332a\" points=\"266.545884 252.621591 265.512344 306.735403 288.16111 306.735403 288.16111 252.218498\"></polygon>\n" +
                "            <polygon id=\"332\" points=\"288.075498 255.363727 288.075498 306.582013 303.922899 306.582013 303.922899 255.363727\"></polygon>\n" +
                "            <polygon id=\"330\" points=\"303.892478 255.41982 303.892478 306.645377 329.633355 306.645377 329.633355 255.41982\"></polygon>\n" +
                "            <polygon id=\"328\" points=\"329.576661 255.320099 329.576661 306.735403 359.626987 306.735403 359.626987 255.320099\"></polygon>\n" +
                "            <polygon id=\"M\" points=\"356.606486 222.018309 356.606486 243.081433 367.89846 243.081433 367.89846 237.183189 400.470011 237.183189 400.470011 222.018309\"></polygon>\n" +
                "            <polygon id=\"318\" points=\"400.557088 217.027285 400.557088 237.071555 418.481543 237.071555 418.481543 217.027285\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"356.277819 255.178307 431.490302 255.178307 431.260723 241.766901 431.260723 223.739066 430.879642 217.81353 429.807472 217.81353 420.342855 217.81353 418.436707 217.81353 418.436707 223.739066 418.436707 237.07202 367.820404 237.07202 367.820404 243.106423 356.277819 243.106423\"></polygon>\n" +
                "            <polygon id=\"326\" points=\"359.559242 255.236596 359.559242 306.68896 381.621954 306.68896 381.621954 255.236596\"></polygon>\n" +
                "            <polygon id=\"324\" points=\"381.602623 255.248213 381.602623 306.64601 405.078985 306.64601 405.078985 255.248213\"></polygon>\n" +
                "            <polygon id=\"322\" points=\"405.092341 255.319679 405.092341 306.619254 431.423068 306.619254 431.423068 255.319679\"></polygon>\n" +
                "            <polygon id=\"stairs\" points=\"418.497601 217.719885 418.497601 207.516164 431.072427 207.516164 431.072427 217.719885\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"418.540109 207.631917 430.96071 207.631917 430.96071 164.056263 398.582277 164.056263 398.582277 217.1343 418.540109 217.1343\"></polygon>\n" +
                "            <polygon id=\"307a\" points=\"363.928333 3.90871408 367.263343 0.100696087 407.43747 0.100696087 407.43747 21.7793427 363.928333 21.7793427\"></polygon>\n" +
                "            <polygon id=\"307\" points=\"363.866037 21.6958013 363.866037 55.6004407 406.66491 55.6004407 406.66491 38.648121 392.552844 38.648121 392.552844 21.6958013\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"407.388144 11.7060469 421.323007 11.7060469 421.323007 163.790915 407.388144 163.790915 406.71686 38.6134235 392.55177 38.6134235 392.55177 21.80084 407.388144 21.80084\"></polygon>\n" +
                "            <polygon id=\"308\" points=\"421.385194 17.7702051 464.095582 17.7702051 464.095582 52.7818864 437.788618 52.7818864 437.788618 49.2357196 421.385194 49.2357196\"></polygon>\n" +
                "            <polygon id=\"306\" points=\"421.40408 49.3911669 421.40408 73.2959132 464.269702 73.2959132 464.269702 52.7811963 437.838035 52.7811963 437.838035 49.3911669\"></polygon>\n" +
                "            <polygon id=\"304\" points=\"421.444947 73.3170669 464.262594 73.3170669 464.262594 123.521839 421.444947 123.521839\"></polygon>\n" +
                "            <polygon id=\"302\" points=\"464.186792 123.481917 464.186792 159.36168 461.508769 163.82443 421.401377 163.82443 421.401377 123.481917\"></polygon>\n" +
                "            <polygon id=\"305\" points=\"363.88967 55.4284621 363.88967 73.3960054 406.827121 73.3960054 406.827121 55.4284621\"></polygon>\n" +
                "            <polygon id=\"303\" points=\"363.898829 73.401571 363.898829 89.866535 406.999584 89.866535 406.999584 73.401571\"></polygon>\n" +
                "            <polygon id=\"301\" points=\"363.905994 90.0304392 363.905994 122.798847 407.167086 122.798847 407.167086 90.0304392\"></polygon>\n" +
                "            <polygon id=\"301a\" points=\"363.890053 122.751368 363.890053 158.413044 369.567163 164.089508 407.45954 164.089508 407.45954 122.751368\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"431.455625 241.567731 435.251937 241.567731 435.251937 239.304084 595.764183 239.304084 595.764183 255.073126 431.455625 255.073126\"></polygon>\n" +
                "            <polygon id=\"319\" points=\"435.278838 239.416072 455.747538 239.416072 455.484513 200.767522 435.278838 200.767522\"></polygon>\n" +
                "            <polygon id=\"317b\" points=\"455.56781 239.310191 494.272998 239.310191 494.272998 200.812175 455.56781 200.812175\"></polygon>\n" +
                "            <polygon id=\"317\" points=\"494.343474 239.280127 515.759951 239.280127 515.759951 200.630577 494.343474 200.630577\"></polygon>\n" +
                "            <polygon id=\"317a\" points=\"515.735394 239.29538 536.320775 239.29538 536.320775 200.460675 515.735394 200.460675\"></polygon>\n" +
                "            <polygon id=\"315\" points=\"536.365898 239.324027 557.63511 239.324027 557.63511 200.590341 536.365898 200.590341\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"557.633232 239.225058 568.323454 239.225058 568.323454 217.020896 557.633232 217.020896\"></polygon>\n" +
                "            <polygon id=\"311\" points=\"557.617824 217.009877 595.402901 217.009877 595.402901 166.805105 557.617824 166.805105\"></polygon>\n" +
                "            <polygon id=\"313\" points=\"568.405647 217.133272 595.6444 217.133272 595.6444 239.329832 568.405647 239.329832\"></polygon>\n" +
                "            <polygon id=\"310\" points=\"555.933692 255.100855 570.193391 255.100855 570.193391 305.009712 555.933692 305.009712\"></polygon>\n" +
                "            <polygon id=\"310a\" points=\"570.1316 255.116022 595.870381 255.116022 595.870381 304.900868 570.1316 304.900868\"></polygon>\n" +
                "            <polygon id=\"312\" points=\"555.765389 255.230106 555.765389 304.97619 535.00114 304.97619 535.00114 255.230106\"></polygon>\n" +
                "            <polygon id=\"314\" points=\"534.908623 255.249178 534.908623 305.020761 514.885548 305.020761 514.885548 255.249178\"></polygon>\n" +
                "            <polygon id=\"316\" points=\"514.819367 255.242387 514.819367 305.117367 493.492253 305.117367 493.492253 255.242387\"></polygon>\n" +
                "            <polygon id=\"318\" points=\"493.355757 255.324118 493.355757 305.158604 473.981392 305.158604 473.981392 255.324118\"></polygon>\n" +
                "            <polygon id=\"318\" points=\"473.837868 255.150054 473.837868 305.103756 453.550188 305.103756 453.550188 255.150054\"></polygon>\n" +
                "            <polygon id=\"320\" points=\"453.411946 255.22245 453.411946 305.136866 435.234488 305.136866 435.234488 255.22245\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"175.981855 238.761586 171.239814 238.761586 171.239814 177.032027 134.666297 177.032027 134.666297 238.761586 134.666297 246.359667 44.8242158 246.359667 44.8242158 204.712027 22.4819942 204.712027 22.4819942 154.95049 44.8242158 127.788966 44.8242158 98.4845691 4.86251592 98.4845691 1.0393696 204.712027 1.0393696 220.04795 24.0951036 220.04795 24.0951036 260.791327 175.981855 258.217704\"></polygon>\n" +
                "            <polygon id=\"341\" points=\"44.7630856 127.851857 69.4242695 127.851857 69.4242695 154.935499 47.6149753 154.935499 41.3918088 154.935499 22.4574071 154.935499\"></polygon>\n" +
                "            <polygon id=\"339\" points=\"45.2388716 160.718855 45.2388716 204.679761 22.4182306 204.679761 22.4182306 154.919012 41.120027 154.919012\"></polygon>\n" +
                "            <polygon id=\"343\" points=\"1.02043808 220.202019 24.1093611 220.202019 24.1093611 260.671598 1.02043808 260.671598\"></polygon>\n" +
                "            <polygon id=\"345\" points=\"0.956012712 260.498454 0.956012712 308.158747 45.6234242 308.481914 44.8970292 260.498454\"></polygon>\n" +
                "            <polygon id=\"346\" points=\"44.7066178 260.638708 45.2764818 308.568246 88.7458514 308.568246 88.7458514 259.637667\"></polygon>\n" +
                "            <polygon id=\"344\" points=\"111.736323 259.304839 111.736323 308.456061 88.7436243 308.456061 88.7436243 259.612033\"></polygon>\n" +
                "            <polygon id=\"342\" points=\"111.717482 308.468978 131.017797 308.468978 131.017797 258.684132 111.717482 259.131733\"></polygon>\n" +
                "            <polygon id=\"340\" points=\"130.994709 258.983015 171.098502 258.45502 171.098502 308.363878 130.994709 308.363878\"></polygon>\n" +
                "            <polygon id=\"337\" points=\"44.8370449 204.702343 65.6185749 204.702343 65.6185749 246.44582 44.8370449 246.44582\"></polygon>\n" +
                "            <polygon id=\"335a\" points=\"65.6061858 204.748777 88.6303472 204.748777 88.6303472 246.339209 65.6061858 246.339209\"></polygon>\n" +
                "            <polygon id=\"335\" points=\"88.6279256 204.704901 107.978794 204.704901 107.978794 246.221286 88.6279256 246.221286\"></polygon>\n" +
                "            <polygon id=\"335b\" points=\"107.895852 204.729865 130.043467 204.729865 130.043467 246.329326 107.895852 246.329326\"></polygon>";
        Document doc = Jsoup.parse(elements);

        List<SchemeElement> schemeElementList = doc.select("polygon")
                .stream()
                .map(polygon -> {
                    SchemeElement schemeElement = new SchemeElement();

                    String info = polygon.attr("id");
                    String points = polygon.attr("points");

                    schemeElement.setBuildingSchemeId(5);
                    schemeElement.setCoordinates(mapPointsToCoordinates(points));
                    schemeElement.setLabel(info);
                    schemeElement.setType(MapElementType.ofString(info));

                    return schemeElement;
                }).collect(Collectors.toList());


        schemeElementRepository.saveAll(schemeElementList);
    }

    private String mapPointsToCoordinates(String points) {
        String[] allPoints = points.split(" ");
        String[] coordinates = new String[allPoints.length / 2];

        for (int i = 0; i < allPoints.length - 1; i += 2) {
            coordinates[i / 2] = allPoints[i] + "," + allPoints[i + 1];
        }

        return String.join(" ", coordinates);
    }
}
