package ru.hse.infotouch.feed.parser;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;
import ru.hse.infotouch.domain.models.enums.MapElementType;
import ru.hse.infotouch.domain.models.map.SchemeElement;
import ru.hse.infotouch.domain.repo.SchemeElementRepository;

import java.util.List;
import java.util.stream.Collectors;

@Component
public class MapParser implements CommandLineRunner {

    private final SchemeElementRepository schemeElementRepository;

    public MapParser(SchemeElementRepository schemeElementRepository) {
        this.schemeElementRepository = schemeElementRepository;
    }

    @Override
    public void run(String... args) throws Exception {
        String elements = "<polygon id=\"333b\" points=\"179.892353 201.596696 210.472464 201.596696 210.472464 238.662118 179.892353 238.662118\"></polygon>\n" +
                "            <polygon id=\"333\" points=\"210.452108 201.702875 210.452108 238.622578 230.337213 238.622578 230.337213 201.702875\"></polygon>\n" +
                "            <polygon id=\"333a\" points=\"230.332728 238.664082 230.332728 201.924253 252.228284 201.924253 252.228284 238.664082\"></polygon>\n" +
                "            <polygon id=\"331a\" points=\"252.236297 238.559505 252.236297 201.913881 272.042996 201.913881 272.042996 238.559505\"></polygon>\n" +
                "            <polygon id=\"331\" points=\"271.989113 238.599193 271.989113 200.909689 292.465243 200.909689 292.465243 238.599193\"></polygon>\n" +
                "            <polygon id=\"329\" points=\"292.45786 200.827794 292.45786 240.756611 310.704117 240.756611 310.704117 200.827794\"></polygon>\n" +
                "            <polygon id=\"327\" points=\"310.821172 200.836188 310.821172 240.772944 329.133903 240.772944 329.133903 200.836188\"></polygon>\n" +
                "            <polygon id=\"325\" points=\"329.149395 200.857758 329.149395 243.079049 360.516717 243.079049 360.516717 221.968403 356.900301 221.968403 356.900301 200.857758\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"179.95588 238.680568 179.95588 257.146006 194.178656 257.146006 194.178656 253.650981 292.072271 252.125486 292.072271 255.212454 360.339741 255.212454 360.339741 243.036682 329.163322 243.036682 329.163322 240.797311 292.47069 240.797311 292.47069 238.680568\"></polygon>\n" +
                "            <polygon id=\"338\" points=\"180.007131 257.037098 180.007131 308.680876 213.532944 308.680876 213.532944 253.61734 194.524779 253.61734 194.524779 257.037098\"></polygon>\n" +
                "            <polygon id=\"336\" points=\"213.403437 253.708549 213.403437 308.75554 236.857904 308.75554 236.857904 253.133272\"></polygon>\n" +
                "            <polygon id=\"334b\" points=\"236.73452 253.370066 236.73452 308.836536 253.96981 308.836536 253.96981 252.717343\"></polygon>\n" +
                "            <polygon id=\"334\" points=\"254.018809 252.887725 254.018809 308.837462 269.702912 308.837462 270.597238 252.462101\"></polygon>\n" +
                "            <polygon id=\"332a\" points=\"270.545884 252.65633 269.594186 306.504548 292.16111 306.504548 292.16111 252.218498\"></polygon>\n" +
                "            <polygon id=\"332\" points=\"292.075498 255.363727 292.075498 306.582013 307.922899 306.582013 307.922899 255.363727\"></polygon>\n" +
                "            <polygon id=\"330\" points=\"307.892478 255.41982 307.892478 306.645377 333.633355 306.645377 333.633355 255.41982\"></polygon>\n" +
                "            <polygon id=\"328\" points=\"333.576661 255.320099 333.576661 306.735403 363.626987 306.735403 363.626987 255.320099\"></polygon>\n" +
                "            <polygon id=\"M\" points=\"360.606486 222.018309 360.606486 243.081433 371.89846 243.081433 371.89846 237.183189 404.470011 237.183189 404.470011 222.018309\"></polygon>\n" +
                "            <polygon id=\"318\" points=\"408.545028 223.084691 408.545028 237.071555 421.450121 237.071555 421.450121 223.084691\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"360.277819 255.178307 435.490302 255.178307 435.490302 223.739066 433.807472 222.470987 433.807472 217.81353 424.342855 217.81353 424.342855 222.470987 422.436707 223.739066 422.436707 237.07202 371.820404 237.07202 371.820404 243.106423 360.277819 243.106423\"></polygon>\n" +
                "            <polygon id=\"326\" points=\"363.559242 255.236596 363.559242 306.68896 385.621954 306.68896 385.621954 255.236596\"></polygon>\n" +
                "            <polygon id=\"324\" points=\"385.602623 255.248213 385.602623 306.64601 409.078985 306.64601 409.078985 255.248213\"></polygon>\n" +
                "            <polygon id=\"322\" points=\"409.092341 255.319679 409.092341 306.619254 435.423068 306.619254 435.423068 255.319679\"></polygon>\n" +
                "            <polygon id=\"stairs\" points=\"422.497601 217.719885 422.497601 207.516164 435.072427 207.516164 435.072427 217.719885\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"422.540109 207.631917 434.96071 207.631917 434.96071 164.056263 402.582277 164.056263 402.582277 217.1343 422.540109 217.1343\"></polygon>\n" +
                "            <polygon id=\"307a\" points=\"367.928333 3.90871408 371.263343 0.100696087 411.43747 0.100696087 411.43747 21.7793427 367.928333 21.7793427\"></polygon>\n" +
                "            <polygon id=\"307\" points=\"367.866037 21.6958013 367.866037 55.6004407 410.66491 55.6004407 410.66491 38.648121 396.552844 38.648121 396.552844 21.6958013\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"411.388144 11.7060469 425.323007 11.7060469 425.323007 163.790915 411.388144 163.790915 410.71686 38.6134235 396.55177 38.6134235 396.55177 21.80084 411.388144 21.80084\"></polygon>\n" +
                "            <polygon id=\"308\" points=\"425.385194 17.7702051 468.095582 17.7702051 468.095582 52.7818864 441.788618 52.7818864 441.788618 49.2357196 425.385194 49.2357196\"></polygon>\n" +
                "            <polygon id=\"306\" points=\"425.40408 49.3911669 425.40408 73.2959132 468.269702 73.2959132 468.269702 52.7811963 441.838035 52.7811963 441.838035 49.3911669\"></polygon>\n" +
                "            <polygon id=\"304\" points=\"425.444947 73.3170669 468.262594 73.3170669 468.262594 123.521839 425.444947 123.521839\"></polygon>\n" +
                "            <polygon id=\"302\" points=\"468.186792 123.481917 468.186792 159.36168 465.508769 163.82443 425.401377 163.82443 425.401377 123.481917\"></polygon>\n" +
                "            <polygon id=\"305\" points=\"367.88967 55.4284621 367.88967 73.3960054 410.827121 73.3960054 410.827121 55.4284621\"></polygon>\n" +
                "            <polygon id=\"303\" points=\"367.898829 73.401571 367.898829 89.866535 410.999584 89.866535 410.999584 73.401571\"></polygon>\n" +
                "            <polygon id=\"301\" points=\"367.905994 90.0304392 367.905994 122.798847 411.167086 122.798847 411.167086 90.0304392\"></polygon>\n" +
                "            <polygon id=\"301a\" points=\"367.890053 122.751368 367.890053 158.413044 373.567163 164.089508 411.45954 164.089508 411.45954 122.751368\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"435.455625 241.567731 439.251937 241.567731 439.251937 239.304084 597.543186 239.304084 597.543186 255.073126 435.455625 255.073126\"></polygon>\n" +
                "            <polygon id=\"319\" points=\"439.278838 239.416072 459.747538 239.416072 459.747538 201.015892 439.278838 201.015892\"></polygon>\n" +
                "            <polygon id=\"317b\" points=\"459.56781 239.310191 498.272998 239.310191 498.272998 200.812175 459.56781 200.812175\"></polygon>\n" +
                "            <polygon id=\"317\" points=\"498.343474 239.280127 519.759951 239.280127 519.759951 200.630577 498.343474 200.630577\"></polygon>\n" +
                "            <polygon id=\"317a\" points=\"519.735394 239.29538 540.320775 239.29538 540.320775 200.460675 519.735394 200.460675\"></polygon>\n" +
                "            <polygon id=\"315\" points=\"540.365898 239.324027 561.63511 239.324027 561.63511 200.590341 540.365898 200.590341\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"561.633232 239.225058 572.323454 239.225058 572.323454 217.020896 561.633232 217.020896\"></polygon>\n" +
                "            <polygon id=\"311\" points=\"561.617824 217.082122 596.325739 217.082122 594.215508 166.805105 563.739973 166.805105\"></polygon>\n" +
                "            <polygon id=\"313\" points=\"572.405647 217.133272 596.642676 217.133272 597.593496 239.329832 572.405647 239.329832\"></polygon>\n" +
                "            <polygon id=\"310\" points=\"559.933692 255.100855 574.193391 255.100855 574.193391 305.009712 559.933692 305.009712\"></polygon>\n" +
                "            <polygon id=\"310a\" points=\"574.1316 255.116022 597.512549 255.116022 599.870381 304.900868 574.1316 304.900868\"></polygon>\n" +
                "            <polygon id=\"312\" points=\"559.765389 255.230106 559.765389 304.97619 539.00114 304.97619 539.00114 255.230106\"></polygon>\n" +
                "            <polygon id=\"314\" points=\"538.908623 255.249178 538.908623 305.020761 518.885548 305.020761 518.885548 255.249178\"></polygon>\n" +
                "            <polygon id=\"316\" points=\"518.819367 255.242387 518.819367 305.117367 497.492253 305.117367 497.492253 255.242387\"></polygon>\n" +
                "            <polygon id=\"318\" points=\"497.355757 255.324118 497.355757 305.158604 477.981392 305.158604 477.981392 255.324118\"></polygon>\n" +
                "            <polygon id=\"318\" points=\"477.837868 255.150054 477.837868 305.103756 457.550188 305.103756 457.550188 255.150054\"></polygon>\n" +
                "            <polygon id=\"320\" points=\"457.411946 255.22245 457.411946 305.136866 439.234488 305.136866 439.234488 255.22245\"></polygon>\n" +
                "            <polygon id=\"corridor\" points=\"179.981855 238.761586 175.239814 238.761586 175.239814 214.57476 138.666297 214.57476 138.666297 238.761586 138.666297 246.359667 48.8242158 246.359667 48.8242158 204.712027 22.4969545 204.712027 26.4819942 154.95049 48.8242158 127.788966 50.61313 104.683895 22.4969545 101.684931 11.0596467 204.712027 8.86251592 220.04795 28.0951036 220.04795 28.0951036 260.791327 179.981855 258.217704\"></polygon>\n" +
                "            <polygon id=\"341\" points=\"48.7630856 127.851857 73.4918163 130.081714 71.0143729 161.298952 50.6486471 160.477983 45.7523063 156.157116 26.4574071 154.935499\"></polygon>\n" +
                "            <polygon id=\"339\" points=\"50.6245719 160.369795 48.8426939 204.679761 22.5302623 204.679761 26.4182306 154.919012 45.7178811 156.204397\"></polygon>\n" +
                "            <polygon id=\"343\" points=\"8.81261296 220.202019 28.1093611 220.202019 28.1093611 260.671598 5.02043808 260.671598\"></polygon>\n" +
                "            <polygon id=\"345\" points=\"4.95601271 260.498454 0.0697138595 311.701128 49.5803791 311.701128 48.8970292 260.498454\"></polygon>\n" +
                "            <polygon id=\"346\" points=\"48.7066178 260.685924 49.5377566 311.770734 92.7458514 311.770734 92.7458514 259.637667\"></polygon>\n" +
                "            <polygon id=\"344\" points=\"115.736323 259.304839 115.736323 311.28638 92.7436243 311.28638 92.7436243 259.627204\"></polygon>\n" +
                "            <polygon id=\"342\" points=\"115.717482 311.315436 135.017797 310.525997 135.017797 258.684132 115.717482 259.160144\"></polygon>\n" +
                "            <polygon id=\"340\" points=\"134.994709 259.016771 175.098502 258.45502 175.098502 309.108279 134.994709 309.108279\"></polygon>\n" +
                "            <polygon id=\"337\" points=\"48.8370449 204.702343 69.6185749 204.702343 69.6185749 246.44582 48.8370449 246.44582\"></polygon>\n" +
                "            <polygon id=\"335a\" points=\"69.6061858 204.748777 92.6303472 204.748777 92.6303472 246.339209 69.6061858 246.339209\"></polygon>\n" +
                "            <polygon id=\"335\" points=\"92.6279256 204.704901 111.978794 204.704901 111.978794 246.221286 92.6279256 246.221286\"></polygon>\n" +
                "            <polygon id=\"335b\" points=\"111.895852 204.729865 134.043467 204.729865 134.043467 246.329326 111.895852 246.329326\"></polygon>\n" +
                "        ";
        Document doc = Jsoup.parse(elements);

        List<SchemeElement> schemeElementList = doc.select("polygon")
                .stream()
                .map(polygon -> {
                    SchemeElement schemeElement = new SchemeElement();

                    String info = polygon.attr("id");
                    String points = polygon.attr("points");

                    schemeElement.setBuildingSchemeId(1);
                    schemeElement.setCoordinates(mapPointsToCoordinates(points));
                    schemeElement.setLabel(info);
                    schemeElement.setType(MapElementType.ofString(info));

                    return schemeElement;
                }).collect(Collectors.toList());


        schemeElementRepository.saveAll(schemeElementList);
    }

    private String mapPointsToCoordinates(String points) {
        String[] allPoints = points.split(" ");
        String[] coordinates = new String[allPoints.length / 2];

        for (int i = 0; i < allPoints.length - 1; i += 2) {
            coordinates[i / 2] = allPoints[i] + "," + allPoints[i + 1];
        }

        return String.join(" ", coordinates);
    }
}
